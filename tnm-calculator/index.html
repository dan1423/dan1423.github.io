<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>HTML 5 Boilerplate</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM"
        crossorigin="anonymous"></script>

    <script src="https://cdn.jsdelivr.net/npm/tom-select@2.2.2/dist/js/tom-select.complete.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/tom-select@2.2.2/dist/css/tom-select.css" rel="stylesheet">
</head>
<style>
    .staging-result {
        font-size: 30px;
    }
    .staging-result .badge{
        display: inline-block;
  width: 20%;
    }

    .staging-result .staging-span{
        display: inline-block;
        width: 100px;
    }

    .ts-dropdown,
    .ts-control,
    .ts-control input {
        font-size: 20px;
    }

    .select-dropdown-definition {
    width:100%;
    overflow:hidden;
}

table tr td {
    font-size: 20px;
    font-weight: bold;
}
    .nostage{
        background-color: bisque;
        width: 50% !important;
    }
    .stage-0{
        background-color: #ffffff;
    }
    .stage-1{
        background-color: #ffb3b3;
    }
    .stage-2{
        background-color: #ff8080;
    }
    .stage-3{
        background-color: #ff4d4d;
    }
    .stage-4{

        background-color: #ff0000;
    }


</style>

<body>
    <div class="container">
        <ul class="nav nav-tabs mt-3" id="mainStageTaabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="stagingCalculator" data-bs-toggle="tab" data-bs-target="#stagingCalculatorTab"
                    type="button" role="tab" aria-controls="home" aria-selected="true">Staging Calculator</button>
            </li>
            <li class="nav-item d-none" role="presentation">
                <button class="nav-link" id="ReverseStagingSearch" data-bs-toggle="tab" data-bs-target="#ReverseSearchTab"
                    type="button" role="tab" aria-controls="profile" aria-selected="false">Reverse Search</button>
            </li>
        </ul>
        <div class="tab-content" id="mainTabStagingContent">
            <div class="tab-pane fade show active" id="stagingCalculatorTab" role="tabpanel" aria-labelledby="stagingCalculator-tab">
                <div class="row mt-2 text-center">
                    <h4>Select Disease Site:</h4>
                </div>
                <div class="row m-1 dropdown-search">
                    <select id="diseaseDropdown">
                    
                    </select>
                </div>
                <ul class="nav nav-tabs mt-3" id="innerStageTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="clinical-tab" data-bs-toggle="tab" data-bs-target="#clinical"
                            type="button" role="tab" aria-controls="home" aria-selected="true">Clinical</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="pathological-tab" data-bs-toggle="tab" data-bs-target="#pathological"
                            type="button" role="tab" aria-controls="profile" aria-selected="false">Pathological</button>
                    </li>
        
                </ul>
                <div class="tab-content" id="calculatorStagingTabContent">
                    <!--clinical tab-->
                    <div class="tab-pane fade show active" id="clinical" role="tabpanel" aria-labelledby="clinical-tab">
                        <!-- <div class="row text-center">
                            <u>
                                <h4 class="staging-header clinical">Clinical Staging</h4>
                            </u>
                        </div> -->
                        <div class="row mt-2">
                            <div class="row staging-result">
                                <strong class="m-1"><span class="badge bg-secondary mr-1">Clinical Stage</span> : <span
                                        id="clincalStage" class="staging-span text-center"></span></strong>
                            </div>
        
                            <table id="criteriaTable" class="table table-bordered">
                                <thead class="table-dark">
                                    <tr>
                                        <th class="col-2">Criteria</th>
                                        <th class="col-4">Definition</th>
                                        <th class="col-4">Criteria List</th>
                                        
                                    </tr>
                                </thead>
                                <tbody id="tbody">
        
                                </tbody>
                            </table>
                        </div>
                    </div>
                    <!--pathological-->
                    <div class="tab-pane fade" id="pathological" role="tabpanel" aria-labelledby="pathological-tab">
                        <!-- <div class="row text-center">
                            <u>
                                <h4 class="staging-header pathological">Pathological Staging</h4>
                            </u>
                        </div> -->
                        <div class="row mt-2">
                            <div class="row staging-result">
                                <strong class="m-1"><span class="mr-1 badge bg-secondary">Pathological Stage</span> : <span
                                        id="pathologicStage" class="staging-span text-center"></span></strong>
                            </div>
        
                            <table id="criteriaTablePath" class="table table-striped">
                                <thead class="table-dark">
                                    <tr>
                                        <th class="col-2">Criteria</th>
                                        <th class="col-2">Criteria List</th>
                                        <th class="col-6">Definition</th>
                                    </tr>
                                </thead>
                                <tbody id="tbodyPath">
        
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>        
            </div>
            <div class="tab-pane" id="ReverseSearchTab" role="tabpanel" aria-labelledby="ReverseSearch-tab">
                <div class="row">
                    <div class="col-md=8">
                        <select id="diseaseDropdownForReverseSearch">
                        
                        </select>
                    </div>
                    <div class="col-md-4">
                        <select id="stageInfoDropDown">
                        <option value="0">Stage 0</option>
                        <option value="1">Stage 1</option>
                        <option value="2">Stage 2</option>
                        <option value="3">Stage 3</option>
                        <option value="4">Stage 4</option>
                        </select>
                    </div>
                </div>
                <div class="row">
                    <table id="reverseSearchTable" class="table">
                        <thead class="table-dark">
                            <tr>
                                <th class="col-2">Criteria</th>
                                <th class="col-2">Stage Group</th>
                            </tr>
                        </thead>
                        <tbody id="tbody">

                        </tbody>
                    </table>
                </div>
               
            </div>
        </div>

        <p>Daniel Oluwadare-- 2023 </p>
    </div>
    <script>

        const BASE_URL ='https://dan1423-001-site1.btempurl.com';
        //const BASE_URL = 'https://localhost:7166';

        let FIRST_LOAD = true;

class PrognosticStagingData {
    T ;
    N ;
    M ;
    AJCCfactorage ;
    AJCCfactorB ;
    AJCCfactorER ;
    AJCCfactorG ;
    AJCCfactorGG ;
    AJCCfactorH ;
    AJCCfactorHER2 ;
    AJCCfactorL ;
    AJCCfactorMR ;
    oncotypedx ;
    AJCCfactorp16hpv ;
    AJCCfactorPR ;
    AJCCfactorPSA ;
    RS ;
    AJCCfactorS ;
    stagegroup ;
  constructor(data) {
    Object.assign(this, data);
  }
}

         let STAGE_0 =[]; 
         let STAGE_1 =[]; 
         let STAGE_2 =[]; 
         let STAGE_3 =[]; 
         let STAGE_4 =[]; 
       
        setDiseaseSites();
        setStagingInfo();

        const DIESASE_DROPDOWN = document.getElementById('diseaseDropdown');
        const DIESASE_DROPDOWN_REVERSE = document.getElementById('diseaseDropdownForReverseSearch');
        const STAGEINFO_DROPDOWN = document.getElementById('stageInfoDropDown');
        const CLINICAL_STAGE_ELEMENT = document.getElementById('clincalStage');
        const PATH_STAGE_ELEMENT =   document.getElementById('pathologicStage');
        DIESASE_DROPDOWN.addEventListener('change', (e) => {
            let diseaseId = DIESASE_DROPDOWN.value;
            let diseaseTitle = e.target.options[e.target.selectedIndex].text;
            //setCriteriaTable(diseaseId);
            SetCriteriaTableForClinicalAndPathological(diseaseId, diseaseTitle);
            reset();
        });

        //on stage level select, we perform a reverse staging search
        STAGEINFO_DROPDOWN.addEventListener('change', (e) => {
            let diseaseId = DIESASE_DROPDOWN_REVERSE.value;
            let level = e.target.value;
           
            setReverseSearchResult(diseaseId,level);

        });
        function setDiseaseSites() {
            fetch(`${BASE_URL}/tnmstaging/diseases`)
                .then((response) => response.json())
                .then((data) => {
                    DIESASE_DROPDOWN.innerHTML = "";
                    for (let i = 0; i < data.length; i++) {
                        let x = data[i];
                        
                        DIESASE_DROPDOWN.insertAdjacentHTML('beforeend', `<option value='${x.AJCCDiseaseId}'>${x.DiseaseTitle}</option>`);
                        DIESASE_DROPDOWN_REVERSE.insertAdjacentHTML('beforeend', `<option value='${x.AJCCDiseaseId}'>${x.DiseaseTitle}</option>`);
                    }

                    new TomSelect("#diseaseDropdown", {
                        create: true,
                        sortField: {
                            field: "text",
                            direction: "asc"
                        }
                    });

                    new TomSelect("#diseaseDropdownForReverseSearch", {
                        create: true,
                        sortField: {
                            field: "text",
                            direction: "asc"
                        }
                    });
                    //initial disease site
                    SetCriteriaTableForClinicalAndPathological(DIESASE_DROPDOWN.value, DIESASE_DROPDOWN.options[DIESASE_DROPDOWN.selectedIndex].text)

                    //initial reverse search
                    setReverseSearchResult(DIESASE_DROPDOWN.value,STAGEINFO_DROPDOWN.value);
                });
        }

        function setStagingInfo() {
            fetch(`${BASE_URL}/tnmstaging/stagingInfo`)
                .then((response) => response.json())
                .then((data) => {
                    for(var i=0;i<data.length;i++){
                        var level = data[i].StageLevel;
                        var stage = data[i].Stage;
                        switch(level){
                            case 0:
                            STAGE_0.push(stage);
                            break;
                            case 1:
                            STAGE_1.push(stage);
                            break;
                            case 2:
                            STAGE_2.push(stage);
                            break;
                            case 3:
                            STAGE_3.push(stage);
                            break;
                            case 4:
                            STAGE_4.push(stage);
                            break;  
                        }
                    }
                   

                });
        }

     


        function SetCriteriaTableForClinicalAndPathological(diseaseId, diseaseTitle) {
            function isEmpty(str) {
                if (!str || str.length === 0) {
                    return true;
                }
                return false;
            }

            if (isEmpty(diseaseId) || isEmpty(diseaseTitle)) {
                return;
            }

            Promise.all([
                fetch(`${BASE_URL}/tnmstaging/staging-data-items-v2/${diseaseId}/1`),
                fetch(`${BASE_URL}/tnmstaging/staging-data-items-v2/${diseaseId}/2`)
            ])
                .then(responses => {
                    return Promise.all(responses.map(response => response.json()));
                })
                .then(data => {
                    let clinicalBody = document.querySelector('#criteriaTable tbody');
                    clinicalBody.innerHTML = "";
                    let inner = createDataTable(data[0], diseaseId, "clinical");
                    clinicalBody.insertAdjacentHTML('beforeend', inner);
                    
                    setDefaultValueForDropdown(document.getElementById("clinical-N"));
                    setDefaultValueForDropdown(document.getElementById("clinical-T"));

                    let pathBody = document.querySelector('#criteriaTablePath tbody');
                    pathBody.innerHTML = "";
                    let innerPath = createDataTable(data[0], diseaseId, "pathological");
                    pathBody.insertAdjacentHTML('beforeend', innerPath);
                   // document.querySelector('.staging-header.pathological').innerHTML = "<i>Pathological Staging For:</i> " + diseaseTitle;


                });
        }

        function setDefaultValueForDropdown(element){
            let index = -1;
            for (const child of element.children) {
                if(child.value.toLowerCase().includes("x")){
                    index = child.index;
                    break;
                }
                }
                if(index !=-1){
                    element.options.selectedIndex = index;  
                        element.dispatchEvent(new Event('change'));                   
                }
          
        }

        function setReverseSearchResult(diseaseId,stageLevel){
            
            let tableBody = document.querySelector('#reverseSearchTable tbody');
            tableBody.innerHTML = "";
                fetch(`${BASE_URL}/tnmstaging/search-by-stage/${diseaseId}/${stageLevel}`)
                .then((response) => response.json())
                .then((data) => {
                    data.forEach(e => {
                       
                        let n = new PrognosticStagingData(e);
                        let curCriteria = [];
                        let curStageGroup = n.stagegroup;
                        Object.keys(n).forEach(function(key,index) {
                        
                            if(n[key]!=null && key !="stagegroup"){
                               curCriteria.push(n[key]);
                            }
                        });
                       
                        tableBody.insertAdjacentHTML('beforeend',`<tr><td>${curCriteria.join(",")}</td><td>${curStageGroup}</td></tr>`);
                    });
                 
                });
        }
 

        function createDataTable(data, diseaseId, stagingTypeName) {
            function isOverflown(element) {
            return element.scrollHeight > element.clientHeight || element.scrollWidth > element.clientWidth;
            }
            let innerHTML = "";
            for (let i = 0; i < data.length; i++) {
                let d = data[i];
                let list = d.ValueDescList;
                let td1 = `<td class="p-2">${d.ColumnName}</td>`;
                let select = `<select id="${stagingTypeName}-${d.ColumnName}"class="${stagingTypeName}-${diseaseId} select-dropdown-definition" data-column="${d.ColumnName}" onchange="handleChange('${stagingTypeName}-${diseaseId}','${diseaseId}','${stagingTypeName}-${d.ColumnName}','td-${stagingTypeName}-${diseaseId}${i}','${stagingTypeName}')">`;
                select += '<option selected="selected" value="">--select--</option>';
                for (let j = 0; j < list.length; j++) {
                    select += `<option value="${list[j].ValidValue}">${list[j].Descr}</option>`;
                }
                select += '</select>';
                let td2 = `<td class="p-2">${select}</td>`;
                let td3 = `<td class="p-2" id="td-${stagingTypeName}-${diseaseId}${i}"></td>`;
                innerHTML += `<tr>${td1}${td2}${td3}</tr>`;
         
            }
            return innerHTML;
        }

        


        function handleChange(className, diseaseId, dropDownId, tdId, stagingTypeName) {
         
         
            let dropdown = document.getElementById(dropDownId);
            let options = dropdown.options;
            let sel = options[dropdown.selectedIndex];
            document.getElementById(`${tdId}`).innerHTML = sel.value
            let urlParamStringClin = generateUrl(className, 1);
            let urlParamStringPath = generateUrl(className, 2);
            let encodedClinUrl = encodeURI(`${BASE_URL}/tnmstaging/calculate?diseaseId=${diseaseId}&${urlParamStringClin}`);
            let encodedPathUrl = encodeURI(`${BASE_URL}/tnmstaging/calculate?diseaseId=${diseaseId}&${urlParamStringPath}`);

            if (stagingTypeName == "clinical") {
                calculateClinical(encodedClinUrl);
            }
            else {
                calculatePathological(encodedPathUrl);
            }
        }



        function calculateClinical(clinUrl, pathUrl) {
            fetch(clinUrl)
                .then((response) => response.json())
                .then((data) => {
                    CLINICAL_STAGE_ELEMENT.innerHTML = data;
                    setStagingColorBasedOnSeverity(CLINICAL_STAGE_ELEMENT,data)
                });
        }

        function calculatePathological(url) {
            fetch(url)
                .then((response) => response.json())
                .then((data) => {   
                    PATH_STAGE_ELEMENT.innerHTML = data;
                    setStagingColorBasedOnSeverity(PATH_STAGE_ELEMENT,data)
                });
        }


        function generateUrl(className, stagingTypeId) {
            let list = [];
            let json = null;
            let count = 0;
            let all = document.querySelectorAll(`.${className}`);
            let urlParamString = `stagingTypeId=${stagingTypeId}`;

            all.forEach(e => {
                let columnName = e.dataset.column;
                let options = e.options;
                let sel = options[e.selectedIndex];

                if (sel.value.trim().length > 0) {
                    urlParamString += `&${columnName}=${sel.value}`;
                }
            });

            return urlParamString;
        }

        function reset(){
            CLINICAL_STAGE_ELEMENT.innerHTML = "";
            PATH_STAGE_ELEMENT.innerHTML = "";
            let cl = ["stage-0","stage-1","stage-2","stage-3","stage-4","nostage"];
            for(let i=0;i<cl.length;i++){
                CLINICAL_STAGE_ELEMENT.classList.remove(cl[i]);
                PATH_STAGE_ELEMENT.classList.remove(cl[i]);
            }
        }

        function setStagingColorBasedOnSeverity(element,stage){
            let cl = ["stage-0","stage-1","stage-2","stage-3","stage-4","nostage"];
            for(let i=0;i<cl.length;i++){
                element.classList.remove(cl[i]);
            }
            
            if(STAGE_0.includes(stage)){
                element.classList.add("stage-0");
                return;
            }
            if(STAGE_1.includes(stage)){
                element.classList.add("stage-1");
                return;
            }
            if(STAGE_2.includes(stage)){
                element.classList.add("stage-2");
                return;
            }
            if(STAGE_3.includes(stage)){
                element.classList.add("stage-3");
                return;
            }
            if(STAGE_4.includes(stage)){
               
                element.classList.add("stage-4");
                return;
            }

            element.classList.add("nostage");
           
        }


    </script>
</body>

</html>